import { useState, useEffect, useCallback } from "react";

const GAFAM_SERVICES = [
  {
    id: "google",
    name: "Google",
    sub: "æ¤œç´¢ / Gmail / Maps / Android / YouTube",
    color: "#ea4335",
    impacts: {
      finance: 0.08, telecom: 0.10, internet: 0.25, civilian: 0.20,
      public: 0.08, electricity: 0.01, gas: 0.00, logistics: 0.15,
      food: 0.02, water: 0.01,
    },
  },
  {
    id: "apple",
    name: "Apple",
    sub: "iOS / App Store / iCloud / Apple Pay",
    color: "#a2aaad",
    impacts: {
      finance: 0.06, telecom: 0.05, internet: 0.05, civilian: 0.12,
      public: 0.03, electricity: 0.01, gas: 0.00, logistics: 0.03,
      food: 0.01, water: 0.00,
    },
  },
  {
    id: "meta",
    name: "Meta",
    sub: "Facebook / Instagram / WhatsApp / Messenger",
    color: "#0668e1",
    impacts: {
      finance: 0.02, telecom: 0.03, internet: 0.08, civilian: 0.12,
      public: 0.04, electricity: 0.00, gas: 0.00, logistics: 0.02,
      food: 0.01, water: 0.00,
    },
  },
  {
    id: "amazon",
    name: "Amazon",
    sub: "AWS / EC2 / S3 / Prime / Alexa",
    color: "#ff9900",
    impacts: {
      finance: 0.25, telecom: 0.05, internet: 0.30, civilian: 0.20,
      public: 0.15, electricity: 0.03, gas: 0.01, logistics: 0.22,
      food: 0.08, water: 0.02,
    },
  },
  {
    id: "microsoft",
    name: "Microsoft",
    sub: "Azure / Windows / Office365 / Teams / GitHub",
    color: "#00a4ef",
    impacts: {
      finance: 0.20, telecom: 0.05, internet: 0.15, civilian: 0.18,
      public: 0.25, electricity: 0.04, gas: 0.02, logistics: 0.12,
      food: 0.03, water: 0.03,
    },
  },
];

const ADDITIONAL_DISRUPTIONS = [
  {
    id: "gps",
    name: "GPSé®æ–­",
    sub: "ç±³å›½GPSè¡›æ˜Ÿã®ä¿¡å·åœæ­¢",
    color: "#ff4444",
    impacts: {
      finance: 0.10, telecom: 0.05, internet: 0.03, civilian: 0.08,
      public: 0.12, electricity: 0.02, gas: 0.01, logistics: 0.30,
      food: 0.06, water: 0.01,
    },
  },
  {
    id: "submarine",
    name: "æµ·åº•ã‚±ãƒ¼ãƒ–ãƒ«åˆ‡æ–­",
    sub: "å¤ªå¹³æ´‹æ¨ªæ–­ã‚±ãƒ¼ãƒ–ãƒ«ã®ç‰©ç†çš„åˆ‡æ–­",
    color: "#cc44ff",
    impacts: {
      finance: 0.15, telecom: 0.10, internet: 0.35, civilian: 0.10,
      public: 0.08, electricity: 0.01, gas: 0.00, logistics: 0.08,
      food: 0.02, water: 0.01,
    },
  },
  {
    id: "energy",
    name: "ã‚¨ãƒãƒ«ã‚®ãƒ¼è¼¸å…¥åœæ­¢",
    sub: "ä¸­æ±åŸæ²¹ / LNGä¾›çµ¦æ–­çµ¶",
    color: "#ff6600",
    impacts: {
      finance: 0.12, telecom: 0.08, internet: 0.08, civilian: 0.12,
      public: 0.18, electricity: 0.55, gas: 0.65, logistics: 0.20,
      food: 0.15, water: 0.08,
    },
  },
];

// Order: civilization uninstall sequence
const INFRA_INDICATORS = [
  { id: "finance",     name: "é‡‘è",         icon: "Â¥", baseVuln: 0.80 },
  { id: "telecom",     name: "é€šä¿¡",         icon: "ğŸ“¡", baseVuln: 0.75 },
  { id: "internet",    name: "ãƒãƒƒãƒˆæ¥ç¶š",    icon: "â—‰", baseVuln: 0.85 },
  { id: "civilian",    name: "æ°‘é–“ã‚µãƒ¼ãƒ“ã‚¹",   icon: "â—ˆ", baseVuln: 0.70 },
  { id: "public",      name: "å…¬å…±ã‚µãƒ¼ãƒ“ã‚¹",   icon: "â—‡", baseVuln: 0.55 },
  { id: "electricity", name: "é›»åŠ›",         icon: "âš¡", baseVuln: 0.85 },
  { id: "gas",         name: "ã‚¬ã‚¹",         icon: "â—†", baseVuln: 0.80 },
  { id: "logistics",   name: "ç‰©æµ",         icon: "â–£", baseVuln: 0.75 },
  { id: "food",        name: "é£Ÿæ–™ä¾›çµ¦",      icon: "â—", baseVuln: 0.62 },
  { id: "water",       name: "æ°´é“",         icon: "â—", baseVuln: 0.30 },
];

const CASCADE_RULES = [
  // electricity hub
  { from: "electricity", to: "water",      factor: 0.35 },
  { from: "electricity", to: "internet",   factor: 0.55 },
  { from: "electricity", to: "civilian",   factor: 0.30 },
  { from: "electricity", to: "public",     factor: 0.25 },
  { from: "electricity", to: "logistics",  factor: 0.20 },
  { from: "electricity", to: "finance",    factor: 0.35 },
  { from: "electricity", to: "telecom",    factor: 0.40 },
  // internet hub
  { from: "internet",    to: "civilian",   factor: 0.40 },
  { from: "internet",    to: "public",     factor: 0.25 },
  { from: "internet",    to: "logistics",  factor: 0.40 },
  { from: "internet",    to: "finance",    factor: 0.50 },
  // telecom
  { from: "telecom",     to: "internet",   factor: 0.35 },
  { from: "telecom",     to: "public",     factor: 0.30 },
  { from: "telecom",     to: "logistics",  factor: 0.20 },
  // finance
  { from: "finance",     to: "civilian",   factor: 0.30 },
  { from: "finance",     to: "logistics",  factor: 0.25 },
  { from: "finance",     to: "public",     factor: 0.15 },
  // logistics
  { from: "logistics",   to: "food",       factor: 0.50 },
  { from: "logistics",   to: "civilian",   factor: 0.15 },
  // gas
  { from: "gas",         to: "electricity", factor: 0.20 },
  // food / water
  { from: "food",        to: "public",     factor: 0.10 },
  { from: "water",       to: "food",       factor: 0.25 },
  { from: "water",       to: "public",     factor: 0.20 },
];

function computeCascade(disabledIds) {
  const allSources = [...GAFAM_SERVICES, ...ADDITIONAL_DISRUPTIONS];
  let direct = {};
  INFRA_INDICATORS.forEach((ind) => (direct[ind.id] = 0));
  disabledIds.forEach((id) => {
    const src = allSources.find((s) => s.id === id);
    if (src) {
      Object.keys(src.impacts).forEach((key) => {
        direct[key] = Math.min(1, direct[key] + src.impacts[key]);
      });
    }
  });
  let state = { ...direct };
  for (let iter = 0; iter < 10; iter++) {
    let cc = {};
    INFRA_INDICATORS.forEach((ind) => (cc[ind.id] = 0));
    CASCADE_RULES.forEach((r) => { cc[r.to] += state[r.from] * r.factor; });
    let maxDiff = 0;
    let next = {};
    Object.keys(state).forEach((k) => {
      next[k] = Math.min(1, direct[k] + cc[k]);
      maxDiff = Math.max(maxDiff, Math.abs(next[k] - state[k]));
    });
    state = next;
    if (maxDiff < 0.001) break;
  }
  return state;
}

function getStatusColor(val) {
  if (val < 0.10) return "#22c55e";
  if (val < 0.25) return "#84cc16";
  if (val < 0.40) return "#eab308";
  if (val < 0.55) return "#f97316";
  if (val < 0.70) return "#ef4444";
  if (val < 0.85) return "#dc2626";
  return "#991b1b";
}

function getStatusLabel(val) {
  if (val < 0.10) return "æ­£å¸¸";
  if (val < 0.25) return "è»½å¾®";
  if (val < 0.40) return "æ³¨æ„";
  if (val < 0.55) return "è­¦æˆ’";
  if (val < 0.70) return "å±é™º";
  if (val < 0.85) return "é‡å¤§";
  return "å£Šæ»…";
}

function Meter({ value, color, label, name, icon, animate }) {
  const pct = Math.round(value * 100);
  return (
    <div style={{
      background: "rgba(15,15,20,0.85)", border: `1px solid ${value > 0.5 ? color : "#333"}`,
      borderRadius: 6, padding: "8px 10px", transition: "all 0.6s ease",
      boxShadow: value > 0.5 ? `0 0 12px ${color}40` : "none",
    }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <span style={{ color: "#ccc", fontSize: 12, fontFamily: "'Noto Sans JP', sans-serif" }}>
          <span style={{ marginRight: 5 }}>{icon}</span>{name}
        </span>
        <span style={{
          color, fontSize: 10, fontWeight: 700, letterSpacing: 1,
          fontFamily: "'JetBrains Mono', monospace",
          animation: value > 0.7 && animate ? "blink 1s infinite" : "none",
        }}>{label}</span>
      </div>
      <div style={{ background: "#1a1a24", borderRadius: 3, height: 16, overflow: "hidden", position: "relative" }}>
        <div style={{
          width: `${pct}%`, height: "100%",
          background: `linear-gradient(90deg, ${color}cc, ${color})`,
          transition: "width 0.8s cubic-bezier(0.4,0,0.2,1)", borderRadius: 3,
        }} />
        <span style={{
          position: "absolute", right: 5, top: 0, fontSize: 10, color: "#fff",
          fontFamily: "'JetBrains Mono', monospace", fontWeight: 700,
          textShadow: "0 0 4px rgba(0,0,0,0.8)",
        }}>{pct}%</span>
      </div>
    </div>
  );
}

function ToggleSwitch({ item, active, onToggle }) {
  return (
    <button onClick={() => onToggle(item.id)} style={{
      display: "flex", alignItems: "center", gap: 8,
      background: active ? `${item.color}18` : "rgba(15,15,20,0.7)",
      border: `1px solid ${active ? item.color : "#333"}`,
      borderRadius: 6, padding: "6px 10px", cursor: "pointer",
      transition: "all 0.3s ease", width: "100%", textAlign: "left",
      boxShadow: active ? `0 0 8px ${item.color}30` : "none",
    }}>
      <div style={{
        width: 32, height: 18, borderRadius: 9,
        background: active ? item.color : "#333",
        position: "relative", transition: "background 0.3s", flexShrink: 0,
      }}>
        <div style={{
          width: 14, height: 14, borderRadius: "50%", background: "#fff",
          position: "absolute", top: 2, left: active ? 16 : 2, transition: "left 0.3s",
        }} />
      </div>
      <div style={{ flex: 1, minWidth: 0 }}>
        <div style={{ color: active ? item.color : "#888", fontSize: 12, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>
          {item.name}
        </div>
        <div style={{ color: "#555", fontSize: 9, marginTop: 1, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
          {item.sub}
        </div>
      </div>
      <div style={{ fontSize: 9, color: active ? "#ff4444" : "#444", fontFamily: "'JetBrains Mono', monospace", fontWeight: 700 }}>
        {active ? "æ–­çµ¶" : "ç¨¼åƒ"}
      </div>
    </button>
  );
}

// Flow diagram: cascade propagation visualization
function FlowDiagram({ cascade, animate }) {
  const nodePositions = {
    finance:     { x: 80,  y: 30 },
    telecom:     { x: 240, y: 30 },
    internet:    { x: 400, y: 30 },
    civilian:    { x: 140, y: 110 },
    public:      { x: 320, y: 110 },
    electricity: { x: 80,  y: 190 },
    gas:         { x: 240, y: 190 },
    logistics:   { x: 400, y: 190 },
    food:        { x: 320, y: 270 },
    water:       { x: 140, y: 270 },
  };

  const activeRules = CASCADE_RULES.filter(
    (r) => cascade[r.from] > 0.05 && cascade[r.to] > 0.05
  );

  return (
    <div style={{
      marginTop: 16, padding: 12, background: "rgba(10,10,15,0.9)",
      border: "1px solid #222", borderRadius: 8,
    }}>
      <div style={{ fontSize: 10, color: "#666", letterSpacing: 2, marginBottom: 8, fontFamily: "'JetBrains Mono', monospace" }}>
        â”€â”€â”€ ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰ä¼æ’­ãƒãƒƒãƒ— â”€â”€â”€
      </div>
      <svg viewBox="0 0 480 310" style={{ width: "100%", height: "auto" }}>
        <defs>
          <marker id="ah" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
            <polygon points="0 0, 6 2, 0 4" fill="#555" />
          </marker>
          <marker id="ah-active" markerWidth="6" markerHeight="4" refX="6" refY="2" orient="auto">
            <polygon points="0 0, 6 2, 0 4" fill="#ff6644" />
          </marker>
        </defs>

        {/* Edges */}
        {CASCADE_RULES.map((rule, i) => {
          const from = nodePositions[rule.from];
          const to = nodePositions[rule.to];
          if (!from || !to) return null;
          const isActive = cascade[rule.from] > 0.05 && cascade[rule.to] > 0.05;
          const strength = rule.factor;
          const dx = to.x - from.x;
          const dy = to.y - from.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const r = 24;
          const sx = from.x + (dx / dist) * r;
          const sy = from.y + (dy / dist) * r;
          const ex = to.x - (dx / dist) * r;
          const ey = to.y - (dy / dist) * r;
          return (
            <line key={i} x1={sx} y1={sy} x2={ex} y2={ey}
              stroke={isActive ? `rgba(255,${Math.round(100 - strength * 80)},${Math.round(68 - strength * 60)},${0.3 + strength * 0.5})` : "#282828"}
              strokeWidth={isActive ? 1 + strength * 2.5 : 0.5}
              markerEnd={isActive ? "url(#ah-active)" : "url(#ah)"}
              style={{ transition: "all 0.8s ease" }}
            />
          );
        })}

        {/* Nodes */}
        {INFRA_INDICATORS.map((ind) => {
          const pos = nodePositions[ind.id];
          if (!pos) return null;
          const val = cascade[ind.id] || 0;
          const color = getStatusColor(val);
          const pct = Math.round(val * 100);
          return (
            <g key={ind.id}>
              <circle cx={pos.x} cy={pos.y} r={22}
                fill={`${color}20`} stroke={color}
                strokeWidth={val > 0.5 ? 2 : 1}
                style={{ transition: "all 0.6s ease" }}
              />
              {val > 0.6 && (
                <circle cx={pos.x} cy={pos.y} r={22}
                  fill="none" stroke={color} strokeWidth={1} opacity={0.3}
                  style={{ animation: animate ? "pulse-ring 2s infinite" : "none" }}
                />
              )}
              <text x={pos.x} y={pos.y - 4} textAnchor="middle"
                fill={color} fontSize={9} fontWeight={700}
                fontFamily="'JetBrains Mono', monospace"
              >{pct}%</text>
              <text x={pos.x} y={pos.y + 10} textAnchor="middle"
                fill="#999" fontSize={8}
                fontFamily="'Noto Sans JP', sans-serif"
              >{ind.name}</text>
            </g>
          );
        })}
      </svg>
      <div style={{ fontSize: 9, color: "#555", marginTop: 6, lineHeight: 1.4, textAlign: "center" }}>
        çŸ¢å°ã®å¤ªã•ï¼ä¼æ’­ä¿‚æ•°ã®å¼·ã•ã€€ï½œã€€ä¸Šä½ï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«å±¤ï¼‰ã‹ã‚‰ä¸‹ä½ï¼ˆç”Ÿå­˜åŸºç›¤ï¼‰ã¸ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰
      </div>
    </div>
  );
}

export default function CascadeSimulator() {
  const [disabled, setDisabled] = useState(new Set());
  const [animate, setAnimate] = useState(false);
  const [showInfo, setShowInfo] = useState(false);

  const toggle = useCallback((id) => {
    setDisabled((prev) => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id); else next.add(id);
      return next;
    });
    setAnimate(true);
  }, []);

  useEffect(() => {
    if (animate) { const t = setTimeout(() => setAnimate(false), 2000); return () => clearTimeout(t); }
  }, [animate]);

  const cascade = computeCascade([...disabled]);
  const totalDisruption = Object.values(cascade).reduce((a, b) => a + b, 0) / INFRA_INDICATORS.length;

  const japanContext = { energy: 15.3, food: 38, digital: 6.7 };

  return (
    <div style={{
      minHeight: "100vh", background: "#0a0a0f", color: "#ddd",
      fontFamily: "'Noto Sans JP', 'JetBrains Mono', monospace",
      padding: "16px", maxWidth: 920, margin: "0 auto",
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap');
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
        @keyframes pulse { 0%,100%{box-shadow:0 0 8px #ff000030} 50%{box-shadow:0 0 20px #ff000060} }
        @keyframes pulse-ring { 0%{r:22;opacity:0.4} 100%{r:32;opacity:0} }
      `}</style>

      {/* Header */}
      <div style={{ marginBottom: 14, borderBottom: "1px solid #222", paddingBottom: 10 }}>
        <div style={{ display: "flex", alignItems: "baseline", gap: 8, flexWrap: "wrap" }}>
          <span style={{ fontSize: 11, color: "#ff4444", fontFamily: "'JetBrains Mono', monospace", fontWeight: 700, letterSpacing: 2 }}>
            NEAR-FUTURE META-RISK #2
          </span>
          <span style={{ fontSize: 10, color: "#444" }}>ï½œ</span>
          <span style={{ fontSize: 10, color: "#555", fontFamily: "'JetBrains Mono', monospace" }}>
            Under-Recognized Future Risks Project
          </span>
        </div>
        <h1 style={{ fontSize: 20, fontWeight: 700, margin: "6px 0 4px", color: "#eee", letterSpacing: 1 }}>
          ã‚¤ãƒ³ãƒ•ãƒ©æ–­çµ¶ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ v3
        </h1>
        <p style={{ fontSize: 11, color: "#666", margin: 0, lineHeight: 1.5 }}>
          GAFAMã‚µãƒ¼ãƒ“ã‚¹ã‚„ç‰©ç†ã‚¤ãƒ³ãƒ•ãƒ©ã‚’åœæ­¢ã•ã›ãŸå ´åˆã®é€£é–çš„å½±éŸ¿ã‚’æ¨å®šã€‚
          æ—¥æœ¬ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼è‡ªçµ¦ç‡{japanContext.energy}%ãƒ»é£Ÿæ–™è‡ªçµ¦ç‡{japanContext.food}%ãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«èµ¤å­—{japanContext.digital}å…†å††ã¨ã„ã†ä¸‰é‡ä¾å­˜æ§‹é€ ã‚’å‰æã¨ã™ã‚‹ã€‚
        </p>
        <button onClick={() => setShowInfo(!showInfo)} style={{
          marginTop: 6, background: "none", border: "1px solid #333",
          color: "#666", fontSize: 10, padding: "3px 8px", borderRadius: 3, cursor: "pointer",
        }}>{showInfo ? "â–¼ å‰æã¨æ³¨æ„" : "â–¶ å‰æã¨æ³¨æ„"}</button>
        {showInfo && (
          <div style={{ marginTop: 8, padding: 10, background: "#111118", borderRadius: 4, fontSize: 10, color: "#888", lineHeight: 1.6, border: "1px solid #222" }}>
            <p style={{ margin: "0 0 4px" }}><strong style={{ color: "#aaa" }}>âš  ã“ã‚Œã¯æ­£ç¢ºãªäºˆæ¸¬ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</strong></p>
            <p style={{ margin: "0 0 4px" }}>
              å½±éŸ¿ç‡ã¯å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã¨æ§‹é€ åˆ†æã«åŸºã¥ãæ¨å®šå€¤ã§ã™ã€‚ã‚»ã‚¯ã‚¿ãƒ¼æ¨ªæ–­çš„ãªçµ±åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç”Ÿæ…‹ç³»çš„ç ´ç¶»äºˆæ¸¬ï¼‰ã¯å­¦è¡“çš„ã«ã‚‚ã¾ã ç©ºç™½åœ°å¸¯ã§ã™ã€‚
            </p>
            <p style={{ margin: "0 0 4px" }}>
              v3æ›´æ–°: é‡‘èãƒ»é€šä¿¡ã‚»ã‚¯ã‚¿ãƒ¼è¿½åŠ ï¼ˆ2025å¹´10æœˆAWS/Azureéšœå®³ã®å®Ÿè¨¼ãƒ‡ãƒ¼ã‚¿åæ˜ ï¼‰ã€‚
              ã‚¤ãƒ³ãƒ•ãƒ©åœæ­¢ç‡ã¯ã€Œæ–‡æ˜ã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é †ã€â€”â€”ãƒ‡ã‚¸ã‚¿ãƒ«ä¸Šä½å±¤ã‹ã‚‰ç”Ÿå­˜åŸºç›¤ã¸â€”â€”ã§è¡¨ç¤ºã€‚
            </p>
            <p style={{ margin: 0, color: "#666" }}>æ•°å€¤ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€Œæ€è€ƒã®é“å…·ã€ã§ã‚ã‚Šäºˆæ¸¬è£…ç½®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        )}
      </div>

      {/* Overall Status */}
      <div style={{
        background: totalDisruption > 0.5 ? "rgba(153,27,27,0.15)" : totalDisruption > 0.25 ? "rgba(234,179,8,0.08)" : "rgba(34,197,94,0.05)",
        border: `1px solid ${getStatusColor(totalDisruption)}40`, borderRadius: 8,
        padding: "10px 14px", marginBottom: 14, display: "flex",
        justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: 8,
        animation: totalDisruption > 0.5 ? "pulse 2s infinite" : "none",
      }}>
        <div>
          <span style={{ fontSize: 10, color: "#888", letterSpacing: 1 }}>ç¤¾ä¼šæ©Ÿèƒ½ ç·åˆåœæ­¢ç‡</span>
          <div style={{ fontSize: 28, fontWeight: 700, color: getStatusColor(totalDisruption), fontFamily: "'JetBrains Mono', monospace" }}>
            {Math.round(totalDisruption * 100)}%
          </div>
        </div>
        <div style={{ textAlign: "right" }}>
          <div style={{ fontSize: 14, fontWeight: 700, color: getStatusColor(totalDisruption), letterSpacing: 2 }}>
            {getStatusLabel(totalDisruption)}
          </div>
          <div style={{ fontSize: 10, color: "#666", marginTop: 2 }}>
            {disabled.size}ä»¶ã®æ–­çµ¶ â†’ {INFRA_INDICATORS.length}ã‚»ã‚¯ã‚¿ãƒ¼ Ã— ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰åæ˜ 
          </div>
        </div>
      </div>

      {/* Main Grid */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
        {/* Left: Controls */}
        <div>
          <div style={{ fontSize: 10, color: "#666", letterSpacing: 2, marginBottom: 6, fontFamily: "'JetBrains Mono', monospace" }}>
            â”€â”€â”€ GAFAM ã‚µãƒ¼ãƒ“ã‚¹ â”€â”€â”€
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 5 }}>
            {GAFAM_SERVICES.map((s) => (
              <ToggleSwitch key={s.id} item={s} active={disabled.has(s.id)} onToggle={toggle} />
            ))}
          </div>

          <div style={{ fontSize: 10, color: "#666", letterSpacing: 2, margin: "12px 0 6px", fontFamily: "'JetBrains Mono', monospace" }}>
            â”€â”€â”€ ç‰©ç†ã‚¤ãƒ³ãƒ•ãƒ© â”€â”€â”€
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 5 }}>
            {ADDITIONAL_DISRUPTIONS.map((s) => (
              <ToggleSwitch key={s.id} item={s} active={disabled.has(s.id)} onToggle={toggle} />
            ))}
          </div>

          <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
            <button onClick={() => {
              setDisabled(new Set([...GAFAM_SERVICES.map((s) => s.id), ...ADDITIONAL_DISRUPTIONS.map((s) => s.id)]));
              setAnimate(true);
            }} style={{
              flex: 1, background: "#331111", border: "1px solid #662222", color: "#ff6666",
              fontSize: 10, padding: "6px", borderRadius: 4, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace",
            }}>å…¨æ–­çµ¶</button>
            <button onClick={() => { setDisabled(new Set()); setAnimate(true); }} style={{
              flex: 1, background: "#112211", border: "1px solid #226622", color: "#66ff66",
              fontSize: 10, padding: "6px", borderRadius: 4, cursor: "pointer", fontFamily: "'JetBrains Mono', monospace",
            }}>å…¨å¾©æ—§</button>
          </div>

          {/* Japan vulnerability context */}
          <div style={{ marginTop: 12, padding: 10, background: "rgba(15,15,20,0.85)", border: "1px solid #222", borderRadius: 6 }}>
            <div style={{ fontSize: 10, color: "#666", letterSpacing: 2, marginBottom: 6, fontFamily: "'JetBrains Mono', monospace" }}>
              â”€â”€â”€ æ—¥æœ¬ã®æ§‹é€ çš„è„†å¼±æ€§ â”€â”€â”€
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
              {[
                { label: "ã‚¨ãƒãƒ«ã‚®ãƒ¼è‡ªçµ¦ç‡", value: japanContext.energy, unit: "%", note: "OECDæœ€ä½æ°´æº–" },
                { label: "é£Ÿæ–™è‡ªçµ¦ç‡", value: japanContext.food, unit: "%", note: "ã‚«ãƒ­ãƒªãƒ¼ãƒ™ãƒ¼ã‚¹" },
                { label: "ãƒ‡ã‚¸ã‚¿ãƒ«èµ¤å­—", value: japanContext.digital, unit: "å…†å††/å¹´", note: "2024å¹´" },
                { label: "æµ·åº•ã‚±ãƒ¼ãƒ–ãƒ«ä¾å­˜", value: 99, unit: "%", note: "å›½éš›é€šä¿¡" },
              ].map((item) => (
                <div key={item.label} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", fontSize: 11 }}>
                  <span style={{ color: "#888" }}>{item.label}</span>
                  <span>
                    <span style={{ color: "#ff8844", fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>
                      {item.value}{item.unit}
                    </span>
                    <span style={{ color: "#555", fontSize: 9, marginLeft: 4 }}>({item.note})</span>
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Right: Indicators in civilization uninstall order */}
        <div>
          <div style={{ fontSize: 10, color: "#666", letterSpacing: 2, marginBottom: 6, fontFamily: "'JetBrains Mono', monospace" }}>
            â”€â”€â”€ ç”Ÿæ´»ã‚¤ãƒ³ãƒ•ãƒ©åœæ­¢ç‡ â”€â”€â”€
          </div>
          <div style={{ fontSize: 9, color: "#555", marginBottom: 6, fontFamily: "'JetBrains Mono', monospace" }}>
            â–² ãƒ‡ã‚¸ã‚¿ãƒ«ä¸Šä½å±¤ â†’ â–¼ ç”Ÿå­˜åŸºç›¤
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 4 }}>
            {INFRA_INDICATORS.map((ind) => {
              const val = cascade[ind.id] || 0;
              return (
                <Meter key={ind.id} value={val} color={getStatusColor(val)}
                  label={getStatusLabel(val)} name={ind.name} icon={ind.icon} animate={animate}
                />
              );
            })}
          </div>
        </div>
      </div>

      {/* Flow Diagram Section */}
      <FlowDiagram cascade={cascade} animate={animate} />

      {/* Cascade explanation */}
      {disabled.size > 0 && (
        <div style={{
          marginTop: 12, padding: 10, background: "rgba(234,179,8,0.05)",
          border: "1px solid #333", borderRadius: 4, fontSize: 10, color: "#888", lineHeight: 1.5,
        }}>
          <span style={{ color: "#eab308", fontWeight: 700 }}>âš¡ ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰åŠ¹æœ:</span>{" "}
          é›»åŠ›åœæ­¢â†’é€šä¿¡ãƒ»ãƒãƒƒãƒˆãƒ»é‡‘èé€£é–ã€ãƒãƒƒãƒˆåœæ­¢â†’é‡‘èãƒ»ç‰©æµãƒ»æ°‘é–“é€£é–ã€
          é‡‘èåœæ­¢â†’æ°‘é–“ãƒ»ç‰©æµãƒ»å…¬å…±é€£é–ã€ç‰©æµåœæ­¢â†’é£Ÿæ–™ä¾›çµ¦é€£é–ã€‚
          å„ã‚»ã‚¯ã‚¿ãƒ¼ã®åœæ­¢ãŒä»–ã‚»ã‚¯ã‚¿ãƒ¼ã‚’æŠ¼ã—ä¸‹ã’ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’åæŸè¨ˆç®—ã€‚
        </div>
      )}

      {/* Footer */}
      <div style={{
        marginTop: 20, paddingTop: 10, borderTop: "1px solid #1a1a1a",
        fontSize: 9, color: "#444", lineHeight: 1.5, textAlign: "center",
      }}>
        Under-Recognized Future Risks Project ï½œ è¿‘æœªæ¥ãƒ¡ã‚¿ãƒªã‚¹ã‚¯#2ï¼šã‚¤ãƒ³ãƒ•ãƒ©æ–­çµ¶ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰ v3
        <br />
        ã‚»ã‚¯ã‚¿ãƒ¼é…åˆ—ï¼šæ–‡æ˜ã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é †ï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ä¸Šä½å±¤â†’ç”Ÿå­˜åŸºç›¤ï¼‰
        <br />
        v3æ›´æ–°: é‡‘èãƒ»é€šä¿¡ã‚»ã‚¯ã‚¿ãƒ¼è¿½åŠ ã€ä¼æ’­ãƒãƒƒãƒ—å®Ÿè£…ã€2025å¹´éšœå®³ãƒ‡ãƒ¼ã‚¿åæ˜ 
        <br />
        <span style={{ color: "#555" }}>
          å‚ç…§: è³‡æºã‚¨ãƒãƒ«ã‚®ãƒ¼åº, è¾²æ—æ°´ç”£çœ, CSIS, Synergy Research, StatCounter, DemandSage
        </span>
      </div>
    </div>
  );
}
