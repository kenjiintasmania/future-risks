import React, { useState, useMemo } from 'react';

const MicroplasticSimulator = () => {
  const [bottledWater, setBottledWater] = useState(7);
  const [tapWater, setTapWater] = useState(7);
  const [teaBags, setTeaBags] = useState(7);
  const [plasticHeating, setPlasticHeating] = useState(3);
  const [showDetails, setShowDetails] = useState(false);

  // ä¿‚æ•°ï¼ˆä¿å®ˆçš„æ¨å®šï¼‰
  const COEFFICIENTS = {
    bottledWater: 100,    // ç²’å­/L
    tapWater: 10,         // ç²’å­/L
    teaBag: 10000,        // ç²’å­/å›ï¼ˆãƒ—ãƒ©è£½ï¼‰
    plasticHeating: 5000  // ç²’å­/å›
  };

  // è¨ˆç®—
  const calculations = useMemo(() => {
    const weeklyParticles = 
      bottledWater * COEFFICIENTS.bottledWater +
      tapWater * COEFFICIENTS.tapWater +
      teaBags * COEFFICIENTS.teaBag +
      plasticHeating * COEFFICIENTS.plasticHeating;
    
    const yearlyParticles = weeklyParticles * 52;
    const fortyYearParticles = yearlyParticles * 40;
    
    // å„çµŒè·¯ã®å¯„ä¸
    const contributions = {
      bottledWater: bottledWater * COEFFICIENTS.bottledWater,
      tapWater: tapWater * COEFFICIENTS.tapWater,
      teaBags: teaBags * COEFFICIENTS.teaBag,
      plasticHeating: plasticHeating * COEFFICIENTS.plasticHeating
    };

    // æœ€å¤§å¯„ä¸è¦å› ã‚’ç‰¹å®š
    const maxContributor = Object.entries(contributions)
      .sort(([,a], [,b]) => b - a)[0];

    // ãƒ¬ãƒ™ãƒ«åˆ¤å®š
    let level, levelColor, levelBg;
    if (weeklyParticles < 1000) {
      level = 'ä½';
      levelColor = 'text-emerald-700';
      levelBg = 'bg-emerald-50 border-emerald-200';
    } else if (weeklyParticles < 10000) {
      level = 'å¹³å‡çš„';
      levelColor = 'text-blue-700';
      levelBg = 'bg-blue-50 border-blue-200';
    } else if (weeklyParticles < 100000) {
      level = 'ã‚„ã‚„é«˜ã‚';
      levelColor = 'text-amber-700';
      levelBg = 'bg-amber-50 border-amber-200';
    } else {
      level = 'é«˜';
      levelColor = 'text-red-700';
      levelBg = 'bg-red-50 border-red-200';
    }

    return {
      weeklyParticles,
      yearlyParticles,
      fortyYearParticles,
      contributions,
      maxContributor,
      level,
      levelColor,
      levelBg
    };
  }, [bottledWater, tapWater, teaBags, plasticHeating]);

  // å‰Šæ¸›ã‚·ãƒŠãƒªã‚ªè¨ˆç®—
  const reductionScenarios = useMemo(() => {
    const scenarios = [];
    
    if (bottledWater > 0) {
      const saved = bottledWater * (COEFFICIENTS.bottledWater - COEFFICIENTS.tapWater);
      scenarios.push({
        action: 'ãƒœãƒˆãƒ«æ°´ã‚’æ°´é“æ°´ã«åˆ‡æ›¿',
        weeklyReduction: saved,
        yearlyReduction: saved * 52,
        icon: 'ğŸš°'
      });
    }
    
    if (teaBags > 0) {
      const saved = teaBags * COEFFICIENTS.teaBag;
      scenarios.push({
        action: 'ãƒªãƒ¼ãƒ•ãƒ†ã‚£ãƒ¼ã¾ãŸã¯ç´™è£½ã«åˆ‡æ›¿',
        weeklyReduction: saved,
        yearlyReduction: saved * 52,
        icon: 'ğŸµ'
      });
    }
    
    if (plasticHeating > 0) {
      const saved = plasticHeating * COEFFICIENTS.plasticHeating;
      scenarios.push({
        action: 'ã‚¬ãƒ©ã‚¹ãƒ»é™¶å™¨å®¹å™¨ã§åŠ ç†±',
        weeklyReduction: saved,
        yearlyReduction: saved * 52,
        icon: 'ğŸ¥£'
      });
    }
    
    return scenarios.sort((a, b) => b.weeklyReduction - a.weeklyReduction);
  }, [bottledWater, teaBags, plasticHeating]);

  const formatNumber = (num) => {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toLocaleString();
  };

  const contributorLabels = {
    bottledWater: 'ãƒœãƒˆãƒ«æ°´',
    tapWater: 'æ°´é“æ°´',
    teaBags: 'ãƒ†ã‚£ãƒ¼ãƒãƒƒã‚°',
    plasticHeating: 'ãƒ—ãƒ©å®¹å™¨åŠ ç†±'
  };

  const SliderInput = ({ label, value, setValue, max, unit, icon }) => (
    <div className="mb-6">
      <div className="flex justify-between items-center mb-2">
        <label className="text-sm font-medium text-gray-700 flex items-center gap-2">
          <span>{icon}</span>
          {label}
        </label>
        <span className="text-sm font-semibold text-gray-900 bg-gray-100 px-3 py-1 rounded-full">
          {value} {unit}
        </span>
      </div>
      <input
        type="range"
        min="0"
        max={max}
        value={value}
        onChange={(e) => setValue(Number(e.target.value))}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
      />
      <div className="flex justify-between text-xs text-gray-400 mt-1">
        <span>0</span>
        <span>{max}</span>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-8">
      <div className="max-w-2xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="text-center mb-8">
          <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
            ãƒã‚¤ã‚¯ãƒ­ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯æ‘‚å–é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
          </h1>
          <p className="text-gray-600 text-sm">
            æ—¥å¸¸ã®ç¿’æ…£ã‹ã‚‰ã€ç›¸å¯¾çš„ãªæ‘‚å–é‡ã‚’æ¨å®šã—ã¾ã™
          </p>
        </div>

        {/* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-sm">1</span>
            é€±é–“ã®ç¿’æ…£ã‚’å…¥åŠ›
          </h2>
          
          <SliderInput
            label="ãƒœãƒˆãƒ«æ°´ã®æ¶ˆè²»é‡"
            value={bottledWater}
            setValue={setBottledWater}
            max={14}
            unit="L/é€±"
            icon="ğŸ¶"
          />
          
          <SliderInput
            label="æ°´é“æ°´ã®æ¶ˆè²»é‡"
            value={tapWater}
            setValue={setTapWater}
            max={14}
            unit="L/é€±"
            icon="ğŸš°"
          />
          
          <SliderInput
            label="ãƒ†ã‚£ãƒ¼ãƒãƒƒã‚°ä½¿ç”¨å›æ•°ï¼ˆãƒ—ãƒ©è£½ï¼‰"
            value={teaBags}
            setValue={setTeaBags}
            max={21}
            unit="å›/é€±"
            icon="ğŸµ"
          />
          
          <SliderInput
            label="ãƒ—ãƒ©å®¹å™¨ã®é›»å­ãƒ¬ãƒ³ã‚¸åŠ ç†±"
            value={plasticHeating}
            setValue={setPlasticHeating}
            max={14}
            unit="å›/é€±"
            icon="ğŸ“¦"
          />
        </div>

        {/* çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <div className={`rounded-2xl shadow-sm border p-6 mb-6 ${calculations.levelBg}`}>
          <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-gray-600 text-sm shadow-sm">2</span>
            æ¨å®šçµæœ
          </h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div className="bg-white/80 backdrop-blur rounded-xl p-4 text-center">
              <div className="text-3xl font-bold text-gray-800">
                {formatNumber(calculations.weeklyParticles)}
              </div>
              <div className="text-sm text-gray-600">ç²’å­/é€±</div>
            </div>
            <div className="bg-white/80 backdrop-blur rounded-xl p-4 text-center">
              <div className="text-3xl font-bold text-gray-800">
                {formatNumber(calculations.yearlyParticles)}
              </div>
              <div className="text-sm text-gray-600">ç²’å­/å¹´</div>
            </div>
            <div className="bg-white/80 backdrop-blur rounded-xl p-4 text-center">
              <div className="text-3xl font-bold text-gray-800">
                {formatNumber(calculations.fortyYearParticles)}
              </div>
              <div className="text-sm text-gray-600">ç²’å­/40å¹´</div>
            </div>
          </div>

          <div className="flex items-center justify-center gap-3 py-3">
            <span className="text-gray-600">æ‘‚å–ãƒ¬ãƒ™ãƒ«:</span>
            <span className={`text-xl font-bold ${calculations.levelColor}`}>
              {calculations.level}
            </span>
          </div>

          {/* å¯„ä¸åº¦ãƒãƒ¼ */}
          <div className="mt-4 bg-white/60 rounded-xl p-4">
            <div className="text-sm font-medium text-gray-700 mb-2">çµŒè·¯åˆ¥ã®å¯„ä¸åº¦</div>
            <div className="flex h-6 rounded-full overflow-hidden bg-gray-100">
              {Object.entries(calculations.contributions).map(([key, value], i) => {
                const percentage = calculations.weeklyParticles > 0 
                  ? (value / calculations.weeklyParticles) * 100 
                  : 0;
                if (percentage === 0) return null;
                const colors = ['bg-blue-500', 'bg-cyan-500', 'bg-amber-500', 'bg-rose-500'];
                return (
                  <div
                    key={key}
                    className={`${colors[i]} transition-all duration-500`}
                    style={{ width: `${percentage}%` }}
                    title={`${contributorLabels[key]}: ${percentage.toFixed(1)}%`}
                  />
                );
              })}
            </div>
            <div className="flex flex-wrap gap-3 mt-2 text-xs">
              {Object.entries(calculations.contributions).map(([key, value], i) => {
                const percentage = calculations.weeklyParticles > 0 
                  ? (value / calculations.weeklyParticles) * 100 
                  : 0;
                if (percentage === 0) return null;
                const colors = ['bg-blue-500', 'bg-cyan-500', 'bg-amber-500', 'bg-rose-500'];
                return (
                  <div key={key} className="flex items-center gap-1">
                    <div className={`w-3 h-3 rounded ${colors[i]}`} />
                    <span className="text-gray-600">{contributorLabels[key]} {percentage.toFixed(0)}%</span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* è¡Œå‹•å¤‰å®¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        {reductionScenarios.length > 0 && (
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span className="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 text-sm">3</span>
              ä»Šæ—¥ã‹ã‚‰ã§ãã‚‹ã“ã¨
            </h2>
            
            <div className="space-y-3">
              {reductionScenarios.map((scenario, i) => (
                <div 
                  key={i}
                  className="flex items-center gap-4 p-4 bg-emerald-50 rounded-xl border border-emerald-100"
                >
                  <div className="text-2xl">{scenario.icon}</div>
                  <div className="flex-1">
                    <div className="font-medium text-gray-800">{scenario.action}</div>
                    <div className="text-sm text-emerald-700">
                      é€± -{formatNumber(scenario.weeklyReduction)} ç²’å­ 
                      ï¼ˆå¹´é–“ -{formatNumber(scenario.yearlyReduction)}ï¼‰
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* æ³¨æ„æ›¸ã */}
        <div className="bg-gray-50 rounded-2xl p-6 border border-gray-200">
          <button 
            onClick={() => setShowDetails(!showDetails)}
            className="flex items-center justify-between w-full text-left"
          >
            <span className="text-sm font-medium text-gray-700">âš ï¸ æ¨å®šå€¤ã«ã¤ã„ã¦</span>
            <span className="text-gray-400">{showDetails ? 'â–²' : 'â–¼'}</span>
          </button>
          
          {showDetails && (
            <div className="mt-4 text-sm text-gray-600 space-y-2">
              <p>
                <strong>ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®é™ç•Œï¼š</strong>
              </p>
              <ul className="list-disc list-inside space-y-1 ml-2">
                <li>æ¸¬å®šæ–¹æ³•ã«ã‚ˆã‚ŠçµæœãŒ2ã€œ5æ¡ç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
                <li>WWFã®ã€Œé€±5gï¼ˆã‚¯ãƒ¬ã‚«1æšï¼‰ã€èª¬ã¯å­¦è¡“çš„ã«å¦å®šã•ã‚Œã¦ã„ã¾ã™</li>
                <li>å®Ÿéš›ã®æ‘‚å–é‡ã¯æ•°Î¼gã€œæ•°ç™¾mg/é€±ã¨æ¨å®šå¹…ãŒéå¸¸ã«åºƒã„ã§ã™</li>
                <li>å¥åº·ãƒªã‚¹ã‚¯ã®é–¾å€¤ã¯ç¾æ™‚ç‚¹ã§ä¸æ˜ã§ã™</li>
              </ul>
              <p className="mt-3">
                <strong>ã“ã®ãƒ„ãƒ¼ãƒ«ã®ç›®çš„ï¼š</strong>
              </p>
              <ul className="list-disc list-inside space-y-1 ml-2">
                <li>çµ¶å¯¾é‡ã§ã¯ãªãã€ç›¸å¯¾çš„ãªæ¯”è¼ƒã¨å‚¾å‘æŠŠæ¡</li>
                <li>è¡Œå‹•å¤‰å®¹ã®æ–¹å‘æ€§ã‚’ç¤ºã™ã“ã¨</li>
                <li>ã€Œã©ã®ç¿’æ…£ãŒå½±éŸ¿å¤§ã‹ã€ã®å¯è¦–åŒ–</li>
              </ul>
              <p className="mt-3 text-xs text-gray-500">
                ä¿‚æ•°å‡ºå…¸: Mason 2018, Hernandez 2019, Mohamed Nor 2021, EWG 2024
              </p>
            </div>
          )}
        </div>

        {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
        <div className="text-center mt-6 text-xs text-gray-400">
          Under-Recognized Future Risks Project
        </div>
      </div>
    </div>
  );
};

export default MicroplasticSimulator;
